#!/bin/bash

# Yikwid Browser Builder
set -e

LW_GIT_REPO=https://codeberg.org/librewolf/source.git
LW_CLONE_TAG=121.0.1-1
LW_CLONE_DIR=upstream-source
YW_BUILD_DIR=yikwid-source

THIS_SCRIPT_NAME="${BASH_SOURCE[0]##*/}"
THIS_SCRIPT_DIR=$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")

upstream_cloned() {
    [ -d "${THIS_SCRIPT_DIR}/${LW_CLONE_DIR}" ]
}

show_help() {
    echo ""
    echo "Yikwid Browser Builder: Script to manage the build process."
    echo ""
    echo "Usage: ${THIS_SCRIPT_NAME} [OPTION...] [ACTION]"
    echo ""
    echo "ACTIONS:"
    echo "  init        - Initialize Yikwid Browser build environment"
    echo "  reset       - Reset the upstream code repository (no update)"
    echo "  pull        - Update upstream code repository (with update)"
    echo "  apply       - Apply Yikwid patches to upstream code"
    echo "OPTIONS:"
    echo "  -d|--debug  - Enable debug info for '${THIS_SCRIPT_NAME}'"
    echo "MAKE PASSTHRU ACTIONS:"
    if upstream_cloned; then
        cd "${THIS_SCRIPT_DIR}/${LW_CLONE_DIR}"
        make help
    else
        echo "  (must run '$THIS_SCRIPT_NAME init' before passthru options can be shown)"
    fi
    echo ""
}

if [[ $1 == "-h" || $1 == "--help" || $1 == "help" ]]; then
    show_help
    exit 0
fi

stderr() {
    2>&1 echo "$*"
}

clone_upstream() {
    if ! which git 2> /dev/null; then
        stderr "ERROR: Must have 'git' installed and available."
        exit 1
    fi
    git clone "$LW_GIT_REPO" "${THIS_SCRIPT_DIR}/${LW_CLONE_DIR}"
}

set_action() {
    declare -g ACTION
    if [[ -n $ACTION ]]; then
        stderr "ERROR: Cannot set action to '$1' as it was already set to '$ACTION'."
        exit 1
    fi
    ACTION="$1"
}

parse_args() {
    declare -g -A OPTIONS
    OPTIONS[DEBUG]=0
    while [[ $# -gt 0 ]]; do
        case $1 in
        all|check|update|clean|veryclean|bootstrap|setup-wasi|fetch|dir|build|package|run|check-patchfail|check-fuzz|fixfuz)
            set_action passthru
            declare -g PASSTHRU="$1"
            shift;;
        init|reset|pull|apply)
            set_action "$1"
            shift;;
        -d|--debug)
            OPTIONS[DEBUG]=1
            shift;;
        *)
            echo "ERROR: Unknown argument: $1"
            exit 1
        esac
    done
}

check_prerequisites() {
    APT_PKGS=(python3 python3-dev python3-pip)
    for APT_PKG in "${APT_PKG[@]}"; do
        if ! dpkg -s "$APT_PKG" > /dev/null 2>&1; then
            echo "ERROR: Missing required package ($APT_PKG) from: ${APT_PKG[*]}"
            exit 1
        fi
    done
}

do_init() {
    if ! upstream_cloned; then
        git clone --single-branch --recurse-submodules --branch "$LW_CLONE_TAG" "$LW_GIT_REPO" "$LW_CLONE_DIR"
        rsync -a "${LW_CLONE_DIR}/" "${YW_BUILD_DIR}/"
    else
        echo "ERROR: Already initialized. Perhaps you meant to run 'reset' or 'pull' instead?"
        exit 1
    fi
}

do_reset() {
    if upstream_cloned; then
        git -C "$LW_CLONE_DIR" reset --hard
        # TODO settings submodule
        # TODO add confirmation
    else
        echo "ERROR: Not yet initialized. Perhaps you meant to run 'init' instead?"
        exit 1
    fi
}

do_pull() {
    :
}

do_apply() {
    :
}

do_action() {
    if [[ -z $ACTION ]]; then
        stderr "You must pass an action to run; try '$THIS_SCRIPT_NAME help' to see options."
        exit 1
    elif [[ $ACTION == passthru ]]; then
        if ! upstream_cloned; then
            stderr "ERROR: Cannot run passthru action '$PASSTHRU'; run '$THIS_SCRIPT_NAME init' first."
            exit 1
        fi

        make -C "${THIS_SCRIPT_DIR}/${LW_CLONE_DIR}" "$PASSTHRU"
    else
        if [[ ${OPTION[DEBUG]} -eq 1 ]]; then
            set -x
        fi
        do_$ACTION
    fi
}

parse_args "$@"
check_prerequisites
do_action
